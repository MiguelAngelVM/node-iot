{"version":3,"sources":["metric-test.js"],"names":["test","require","sinon","proxyquire","metricFixtures","agentFixtures","config","logging","AgentStub","hasMany","spy","db","MetricStub","uuid","type","agentId","metricTypes","byAgentUuid","metricTypesUuid","byTypeAgentUuid","sandbox","uuidArgs","attributes","group","include","model","where","raw","typeUuidArgs","limit","order","oneAgentArgs","newMetric","value","createdAt","Date","updatedAt","newMetricWithAgentId","agentArgs","beforeEach","belongsTo","create","findOne","stub","withArgs","returns","Promise","resolve","byUuid","findAll","all","findByAgentUuid","findByTypeAgentUuid","toJSON","Object","assign","setupDatabase","afterEach","restore","t","truthy","Metric","serial","metric","true","called","calledOnce","calledWith","deepEqual"],"mappings":"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","file":"metric-test.js","sourcesContent":["'use strict'\n\nconst test = require('ava')\nconst sinon = require('sinon')\nconst proxyquire = require('proxyquire')\n\nconst metricFixtures = require('./fixtures/metric')\nconst agentFixtures = require('./fixtures/agent')\n\nlet config = {\n  logging: function () { }\n}\n\nlet AgentStub = {\n  hasMany: sinon.spy()\n}\n\nlet db = null\nlet MetricStub = null\nlet uuid = 'yyy-yyy-yyy'\nlet type = 'humidity'\nlet agentId = 1\nlet metricTypes = metricFixtures.byAgentUuid(uuid)\nlet metricTypesUuid = metricFixtures.byTypeAgentUuid(type, uuid)\n\nlet sandbox = null\n\nlet uuidArgs = {\n  attributes: ['type'],\n  group: ['type'],\n  include: [{\n    attributes: [],\n    model: AgentStub,\n    where: {\n      uuid\n    }\n  }],\n  raw: true\n}\n\nlet typeUuidArgs = {\n  attributes: ['id', 'type', 'value', 'createdAt'],\n  where: {\n    type\n  },\n  limit: 20,\n  order: [['createdAt', 'DESC']],\n  include: [{\n    attributes: [],\n    where: {\n      uuid\n    }\n  }],\n  raw: true\n}\n\nlet oneAgentArgs = {\n  where: {\n    uuid\n  }\n}\n\nlet newMetric = {\n  type: 'light',\n  value: '20 lumens',\n  createdAt: new Date(),\n  updatedAt: new Date()\n}\n\nlet newMetricWithAgentId = {\n  agentId: agentId,\n  type: 'light',\n  value: '20 lumens',\n  createdAt: new Date(),\n  updatedAt: new Date()\n}\n\nlet agentArgs = {\n  where: {\n    uuid\n  }\n}\n\ntest.beforeEach(async () => {\n  MetricStub = {\n    belongsTo: sinon.spy()\n  }\n\n  sandbox = sinon.sandbox.create()\n\n  // Agent findOne Stub\n  AgentStub.findOne = sandbox.stub()\n  AgentStub.findOne.withArgs(agentArgs).returns(Promise.resolve(agentFixtures.byUuid(uuid)))\n\n  // Model findAll Stub\n  MetricStub.findAll = sandbox.stub()\n  MetricStub.findAll.withArgs().returns(Promise.resolve(metricFixtures.all))\n  MetricStub.findAll.withArgs(uuidArgs).returns(Promise.resolve(metricFixtures.byAgentUuid(uuid)))\n  MetricStub.findAll.withArgs(typeUuidArgs).returns(Promise.resolve(metricFixtures.byTypeAgentUuid(type, uuid)))\n\n  // Model findByAgentUuid Stub\n  MetricStub.findByAgentUuid = sandbox.stub()\n  MetricStub.findByAgentUuid.withArgs(uuid).returns(Promise.resolve(metricFixtures.byAgentUuid(uuid)))\n\n  // Model findByTypeAgentUuid Stub\n  MetricStub.findByTypeAgentUuid = sandbox.stub()\n  MetricStub.findByTypeAgentUuid.withArgs(type, uuid).returns(Promise.resolve(metricFixtures.byTypeAgentUuid(type, uuid)))\n\n  // Model create Stub\n  MetricStub.create = sandbox.stub()\n  MetricStub.create.withArgs(newMetric).returns(Promise.resolve({\n    toJSON () { return Object.assign(newMetric, {agentId: agentId}) }\n  }))\n\n  const setupDatabase = proxyquire('../', {\n    './models/agent': () => AgentStub,\n    './models/metric': () => MetricStub\n  })\n  db = await setupDatabase(config)\n})\n\ntest.afterEach(() => {\n  sandbox && sinon.sandbox.restore()\n})\n\ntest('Metric', t => {\n  t.truthy(db.Metric, 'Metric service should exist')\n})\n\ntest.serial('Metric#findByUuid', async t => {\n  let metric = await db.Metric.findByAgentUuid(uuid)\n\n  t.true(MetricStub.findAll.called, 'findAll should be called on Model')\n  t.true(MetricStub.findAll.calledOnce, 'findAll should be called once')\n  t.true(MetricStub.findAll.calledWith(uuidArgs), 'findAll should be called with specified args')\n\n  t.deepEqual(metric, metricTypes, 'Should be the same')\n})\n\ntest.serial('Metric#findByTypeAgentUuid', async t => {\n  let metric = await db.Metric.findByTypeAgentUuid(type, uuid)\n  t.true(MetricStub.findAll.called, 'findAll should be called on Model')\n  t.true(MetricStub.findAll.calledOnce, 'findAll should be called once')\n  t.true(MetricStub.findAll.calledWith(typeUuidArgs), 'findAll should be called with specified args')\n\n  t.deepEqual(metric, metricTypesUuid, 'Should be the same')\n})\n\ntest.serial('Metric#create', async t => {\n  let metric = await db.Metric.create(uuid, newMetric)\n\n  t.true(AgentStub.findOne.called, 'findOne should be called on Model')\n  t.true(AgentStub.findOne.calledOnce, 'findOne should be called once')\n  t.true(AgentStub.findOne.calledWith(oneAgentArgs), 'findOne should be called with specified agentId')\n\n  t.true(MetricStub.create.called, 'create should be called on model')\n  t.true(MetricStub.create.calledOnce, 'create should be called once')\n  t.true(MetricStub.create.calledWith(newMetric), 'create should be called with specified args')\n\n  t.deepEqual(metric, newMetricWithAgentId, 'Should be the same Metric')\n})"]}